const { getConnection } = require("../config/db");
const oracledb = require("oracledb");

/**
 * Add a new comment
 * POST /api/comments
 */
exports.addComment = async (req, res) => {
  let conn;
  try {
    const { comment_text, post_id, user_id } = req.body;

    if (!comment_text || !post_id || !user_id) {
      return res.status(400).json({ message: "All fields are required" });
    }

    conn = await getConnection();

    // ID and created_at are auto-generated by Oracle (IDENTITY + DEFAULT)
    await conn.execute(
      `INSERT INTO comments (comment_text, post_id, user_id)
       VALUES (:comment_text, :post_id, :user_id)`,
      { comment_text, post_id, user_id },
      { autoCommit: true }
    );

    res.status(201).json({ message: "Comment added successfully" });

  } catch (error) {
    console.error("Add Comment Error:", error);
    res.status(500).json({ message: "Failed to add comment" });
  } finally {
    if (conn) await conn.close();
  }
};

/**
 * Get comments by post ID
 * GET /api/comments/:postId
 */
exports.getCommentsByPost = async (req, res) => {
  let conn;
  try {
    const { postId } = req.params;

    conn = await getConnection();

    const result = await conn.execute(
      `SELECT 
          c.id,
          c.comment_text,
          u.name AS author,
          TO_CHAR(c.created_at, 'DD-MON-YYYY HH24:MI') AS created_at
       FROM comments c
       JOIN users u ON c.user_id = u.id
       WHERE c.post_id = :postId
       ORDER BY c.created_at ASC`,
      { postId },
      { outFormat: oracledb.OUT_FORMAT_OBJECT }
    );

    res.status(200).json(result.rows);

  } catch (error) {
    console.error("Fetch Comments Error:", error);
    res.status(500).json({ message: "Failed to fetch comments" });
  } finally {
    if (conn) await conn.close();
  }
};

/**
 * Delete a comment
 * DELETE /api/comments/:id
 */
exports.deleteComment = async (req, res) => {
  let conn;
  try {
    const { id } = req.params;

    conn = await getConnection();

    const result = await conn.execute(
      `DELETE FROM comments WHERE id = :id`,
      { id },
      { autoCommit: true }
    );

    if (result.rowsAffected === 0) {
      return res.status(404).json({ message: "Comment not found" });
    }

    res.status(200).json({ message: "Comment deleted successfully" });

  } catch (error) {
    console.error("Delete Comment Error:", error);
    res.status(500).json({ message: "Failed to delete comment" });
  } finally {
    if (conn) await conn.close();
  }
};
